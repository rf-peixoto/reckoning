<!-- templates/settings.html -->
{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-between align-center mb-20">
    <h2 style="color: var(--accent);">
        <i class="fas fa-cog"></i> Application Settings
    </h2>
    <div>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
    </div>
</div>

<div class="card mb-20">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-info-circle"></i> System Information
        </div>
    </div>
    <div class="card-body">
        <div class="d-flex gap-20" style="flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">Platform Info</h4>
                <table style="width: 100%; color: var(--text-muted);">
                    <tr>
                        <td style="padding: 8px 0;"><strong>Python Version:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.python_version.split()[0] }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>Platform:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.platform }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>CPU Cores:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.cpu_count }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>Workflows:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.workflows_count }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>Executions:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.executions_count }}</td>
                    </tr>
                </table>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">Disk Usage</h4>
                <div style="background: var(--primary); border-radius: 4px; padding: 15px;">
                    <div style="margin-bottom: 10px;">
                        <div class="d-flex justify-between">
                            <span>Used</span>
                            <span>{{ "%.1f"|format(system_info.disk_usage.used / (1024**3)) }} GB</span>
                        </div>
                        <div class="progress-bar" style="margin-top: 5px;">
                            <div class="progress-fill" style="width: {{ (system_info.disk_usage.used / system_info.disk_usage.total * 100)|round|int }}%;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <div class="d-flex justify-between">
                            <span>Free</span>
                            <span>{{ "%.1f"|format(system_info.disk_usage.free / (1024**3)) }} GB</span>
                        </div>
                        <div class="progress-bar" style="margin-top: 5px;">
                            <div class="progress-fill" style="width: {{ (system_info.disk_usage.free / system_info.disk_usage.total * 100)|round|int }}%; background: var(--success);"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-between mt-10">
                        <strong>Total</strong>
                        <strong>{{ "%.1f"|format(system_info.disk_usage.total / (1024**3)) }} GB</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-20">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-sliders-h"></i> Application Settings
        </div>
    </div>
    <div class="card-body">
        <form id="settingsForm">
            <div class="d-flex gap-20" style="flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="enable_logging" {% if settings.enable_logging %}checked{% endif %}>
                            Enable Logging
                        </label>
                        <div class="form-text">Log all execution activities</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="auto_cleanup" {% if settings.auto_cleanup %}checked{% endif %}>
                            Auto Cleanup
                        </label>
                        <div class="form-text">Automatically clean up temporary files</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="notifications" {% if settings.notifications %}checked{% endif %}>
                            Enable Notifications
                        </label>
                        <div class="form-text">Show desktop notifications</div>
                    </div>
                </div>
                
                <div style="flex: 1; min-width: 300px;">
                    <div class="form-group">
                        <label class="form-label">Max Execution Time (seconds)</label>
                        <input type="number" class="form-control" name="max_execution_time" 
                               value="{{ settings.max_execution_time }}" min="7" max="9999">
                        <div class="form-text">Maximum time per tool execution</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Max Output Size (characters)</label>
                        <input type="number" class="form-control" name="max_output_size" 
                               value="{{ settings.max_output_size }}" min="1000" max="1000000">
                        <div class="form-text">Maximum output size to store per tool</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Default Theme</label>
                        <select class="form-control" name="default_theme">
                            <option value="dark" {% if settings.default_theme == 'dark' %}selected{% endif %}>Dark</option>
                            <option value="light" {% if settings.default_theme == 'light' %}selected{% endif %}>Light</option>
                            <option value="blue" {% if settings.default_theme == 'blue' %}selected{% endif %}>Blue</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-between mt-20">
                <button type="button" onclick="resetSettings()" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
                <button type="button" onclick="saveSettings()" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-database"></i> Data Management
        </div>
    </div>
    <div class="card-body">
        <div class="d-flex gap-20" style="flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">Backup</h4>
                <p style="color: var(--text-muted); margin-bottom: 15px;">
                    Create a backup of all workflows and execution history
                </p>
                <button onclick="createBackup()" class="btn btn-success">
                    <i class="fas fa-save"></i> Create Backup
                </button>
            </div>
            
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">Restore</h4>
                <p style="color: var(--text-muted); margin-bottom: 15px;">
                    Restore from a previously created backup file
                </p>
                <form id="restoreForm" action="{{ url_for('restore_settings') }}" method="POST" enctype="multipart/form-data">
                    <div class="d-flex gap-10">
                        <input type="file" name="file" accept=".json" class="form-control" style="flex: 1;">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-upload"></i> Restore
                        </button>
                    </div>
                    <div class="form-group mt-10">
                        <label class="form-label">
                            <input type="checkbox" name="restore_executions" value="true">
                            Restore execution history
                        </label>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="alert alert-warning mt-20">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Warning:</strong> Restoring from backup will replace all current data. Make sure you have a current backup before restoring.
        </div>
    </div>
</div>

<div class="card mt-20">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-shield-alt"></i> Security & Compliance
        </div>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Important:</strong> This tool is for authorized security testing only.
        </div>
        
        <div class="form-group">
            <label class="form-label">Compliance Notes</label>
            <textarea class="form-control" rows="3" placeholder="Add compliance notes or authorization details..."></textarea>
            <div class="form-text">These notes will be included in all execution logs</div>
        </div>
        
        <button onclick="showComplianceInfo()" class="btn btn-primary">
            <i class="fas fa-file-contract"></i> View Compliance Guidelines
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function saveSettings() {
        const formData = new FormData(document.getElementById('settingsForm'));
        const data = {};
        formData.forEach((value, key) => {
            if (value === 'on') {
                data[key] = true;
            } else if (!isNaN(value) && value !== '') {
                data[key] = Number(value);
            } else {
                data[key] = value;
            }
        });
        
        fetch('/settings/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Settings saved successfully!', 'success');
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error: ' + error, 'danger');
        });
    }
    
    function resetSettings() {
        if (confirm('Reset all settings to default values?')) {
            document.getElementById('settingsForm').reset();
            showAlert('Settings reset to defaults', 'info');
        }
    }
    
    function createBackup() {
        fetch('/settings/backup', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Backup created: ' + data.filename, 'success');
                // Optionally trigger download
                window.location.href = '/settings/backup?download=' + data.filename;
            } else {
                showAlert('Error creating backup: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error: ' + error, 'danger');
        });
    }
    
    function showComplianceInfo() {
        const complianceInfo = `
        <h4>Compliance Guidelines</h4>
        <ul>
            <li>Only test systems you own or have explicit written permission to test</li>
            <li>Respect all applicable laws and regulations</li>
            <li>Do not test production systems without authorization</li>
            <li>Keep all test results confidential and secure</li>
            <li>Report any accidental access to unauthorized systems immediately</li>
            <li>Maintain detailed logs of all testing activities</li>
            <li>Follow responsible disclosure practices for any findings</li>
        </ul>
        `;
        
        // Create a modal or alert with this info
        alert(complianceInfo.replace(/<[^>]*>/g, '')); // Simple alert version
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} mt-20`;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
            ${message}
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => alertDiv.remove(), 5000);
    }
    
    // Handle restore form submission
    document.getElementById('restoreForm').addEventListener('submit', function(e) {
        if (!confirm('WARNING: This will replace all current data. Are you sure you want to continue?')) {
            e.preventDefault();
            return false;
        }
        return true;
    });
</script>
{% endblock %}