<!-- templates/settings.html -->
{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-between align-center mb-20">
    <h2 style="color: var(--accent);">
        <i class="fas fa-cog"></i> Application Settings
    </h2>
    <div>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
    </div>
</div>

<div class="card mb-20">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-info-circle"></i> System Information
        </div>
    </div>
    <div class="card-body">
        <div class="d-flex gap-20" style="flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">Platform Info</h4>
                <table style="width: 100%; color: var(--text-muted);">
                    <tr>
                        <td style="padding: 8px 0;"><strong>Python Version:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.python_version.split()[0] }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>Platform:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.platform }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>CPU Cores:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.cpu_count }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>Workflows:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.workflows_count }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>Executions:</strong></td>
                        <td style="padding: 8px 0;">{{ system_info.executions_count }}</td>
                    </tr>
                </table>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">Disk Usage</h4>
                <div style="background: var(--primary); border-radius: 4px; padding: 15px;">
                    <div style="margin-bottom: 10px;">
                        <div class="d-flex justify-between">
                            <span>Used</span>
                            <span>{{ "%.1f"|format(system_info.disk_usage.used / (1024**3)) }} GB</span>
                        </div>
                        <div class="progress-bar" style="margin-top: 5px;">
                            <div class="progress-fill" style="width: {{ (system_info.disk_usage.used / system_info.disk_usage.total * 100)|round|int }}%;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <div class="d-flex justify-between">
                            <span>Free</span>
                            <span>{{ "%.1f"|format(system_info.disk_usage.free / (1024**3)) }} GB</span>
                        </div>
                        <div class="progress-bar" style="margin-top: 5px;">
                            <div class="progress-fill" style="width: {{ (system_info.disk_usage.free / system_info.disk_usage.total * 100)|round|int }}%; background: var(--success);"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-between mt-10">
                        <strong>Total</strong>
                        <strong>{{ "%.1f"|format(system_info.disk_usage.total / (1024**3)) }} GB</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-20">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-sliders-h"></i> Application Settings
        </div>
    </div>
    <div class="card-body">
        <form id="settingsForm">
            <div class="d-flex gap-20" style="flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="enable_logging" {% if settings.enable_logging %}checked{% endif %}>
                            Enable Logging
                        </label>
                        <div class="form-text">Log all execution activities</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="auto_cleanup" {% if settings.auto_cleanup %}checked{% endif %}>
                            Auto Cleanup
                        </label>
                        <div class="form-text">Automatically clean up temporary files</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="notifications" {% if settings.notifications %}checked{% endif %}>
                            Enable Notifications
                        </label>
                        <div class="form-text">Show desktop notifications</div>
                    </div>
                </div>
                
                <div style="flex: 1; min-width: 300px;">
                    <div class="form-group">
                        <label class="form-label">Max Execution Time (seconds)</label>
                        <input type="number" class="form-control" name="max_execution_time" 
                               value="{{ settings.max_execution_time }}" min="7" max="99999">
                        <div class="form-text">Maximum time per tool execution</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Max Output Size (characters)</label>
                        <input type="number" class="form-control" name="max_output_size" 
                               value="{{ settings.max_output_size }}" min="1000" max="9999999">
                        <div class="form-text">Maximum output size to store per tool</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Default Theme</label>
                        <select class="form-control" name="default_theme">
                            <option value="dark" {% if settings.default_theme == 'dark' %}selected{% endif %}>Dark</option>
                            <option value="light" {% if settings.default_theme == 'light' %}selected{% endif %}>Light</option>
                            <option value="blue" {% if settings.default_theme == 'blue' %}selected{% endif %}>Blue</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-between mt-20">
                <button type="button" onclick="resetSettings()" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
                <button type="button" onclick="saveSettings()" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-database"></i> Data Management
        </div>
    </div>
    <div class="card-body">
        <div class="d-flex gap-20" style="flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">Backup</h4>
                <p style="color: var(--text-muted); margin-bottom: 15px;">
                    Create a backup of all workflows and execution history
                </p>
                <button onclick="createBackup()" class="btn btn-success">
                    <i class="fas fa-save"></i> Create Backup
                </button>
            </div>
            
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">Restore</h4>
                <p style="color: var(--text-muted); margin-bottom: 15px;">
                    Restore from a previously created backup file
                </p>
                <form id="restoreForm" action="{{ url_for('restore_settings') }}" method="POST" enctype="multipart/form-data">
                    <div class="d-flex gap-10">
                        <input type="file" name="file" accept=".json" class="form-control" style="flex: 1;">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-upload"></i> Restore
                        </button>
                    </div>
                    <div class="form-group mt-10">
                        <label class="form-label">
                            <input type="checkbox" name="restore_executions" value="true">
                            Restore execution history
                        </label>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="alert alert-warning mt-20">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Warning:</strong> Restoring from backup will replace all current data. Make sure you have a current backup before restoring.
        </div>
    </div>
</div>

<!-- Tool Library and Wordlists configuration -->
<div class="card mb-20">
    <div class="card-header">
        <h3 style="margin: 0; color: var(--accent);">
            <i class="fas fa-toolbox"></i> Tool Library
        </h3>
        <div style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">
            Configure tools once. Workflows can then select a tool and optionally override fields per step.
        </div>
    </div>
    <div class="card-body">
        <div class="d-flex gap-10 mb-10" style="flex-wrap: wrap;">
            <input id="tl_name" class="form-control" style="min-width: 160px; max-width: 240px;" placeholder="Name (e.g., ffuf)">
            <input id="tl_path" class="form-control" style="min-width: 220px; flex: 1;" placeholder="Path (e.g., /usr/bin/ffuf)">
            <input id="tl_default_cmd" class="form-control" style="min-width: 260px; flex: 2;" placeholder="Default Command (args template)">
            <input id="tl_update_cmd" class="form-control" style="min-width: 220px; flex: 1;" placeholder="Update Command (args)">
        </div>
        <div class="mb-10">
            <textarea id="tl_desc" class="form-control" rows="2" placeholder="Description"></textarea>
        </div>
        <button class="btn btn-primary" onclick="addToolLibraryItem()">
            <i class="fas fa-plus"></i> Add Tool
        </button>

        <div class="mt-20" style="overflow-x: auto;">
            <table class="table" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Path</th>
                        <th>Default Command</th>
                        <th>Update Command</th>
                        <th>Description</th>
                        <th style="width: 90px;"></th>
                    </tr>
                </thead>
                <tbody id="toolLibraryTable"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mb-20">
    <div class="card-header">
        <h3 style="margin: 0; color: var(--accent);">
            <i class="fas fa-list"></i> Wordlists
        </h3>
        <div style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">
            Define named wordlists once. Use them in tool commands/args as placeholders like <code>{wordlist1}</code>.
        </div>
    </div>
    <div class="card-body">
        <div class="d-flex gap-10 mb-10" style="flex-wrap: wrap;">
            <input id="wl_name" class="form-control" style="min-width: 160px; max-width: 240px;" placeholder="Name (e.g., wordlist1)">
            <input id="wl_path" class="form-control" style="min-width: 320px; flex: 1;" placeholder="Path (e.g., /path/to/wordlist.txt)">
        </div>
        <button class="btn btn-primary" onclick="addWordlist()">
            <i class="fas fa-plus"></i> Add Wordlist
        </button>

        <div class="mt-20" style="overflow-x: auto;">
            <table class="table" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Path</th>
                        <th style="width: 90px;"></th>
                    </tr>
                </thead>
                <tbody id="wordlistsTable"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mt-20">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-shield-alt"></i> Security Notes
        </div>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Important:</strong> This tool is for authorized security testing only. The authors are not responsible for malicious use.
        </div>
        
        <div class="form-group">
            <label class="form-label">User Notes</label>
            <textarea class="form-control" rows="3" placeholder="Add compliance notes or authorization details..."></textarea>
            <div class="form-text">These notes will be included in all execution logs</div>
        </div>
        
        <button onclick="showComplianceInfo()" class="btn btn-primary">
            <i class="fas fa-file-contract"></i> Terms of Use
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function saveSettings() {
        const formData = new FormData(document.getElementById('settingsForm'));
        const data = {};
        formData.forEach((value, key) => {
            if (value === 'on') {
                data[key] = true;
            } else if (!isNaN(value) && value !== '') {
                data[key] = Number(value);
            } else {
                data[key] = value;
            }
        });
        
        fetch('/settings/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Settings saved successfully!', 'success');
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error: ' + error, 'danger');
        });
    }
    
    function resetSettings() {
        if (confirm('Reset all settings to default values?')) {
            document.getElementById('settingsForm').reset();
            showAlert('Settings reset to defaults', 'info');
        }
    }
    
    function createBackup() {
        fetch('/settings/backup', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Backup created: ' + data.filename, 'success');
                // Optionally trigger download
                window.location.href = '/settings/backup?download=' + data.filename;
            } else {
                showAlert('Error creating backup: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error: ' + error, 'danger');
        });
    }
    
    function showComplianceInfo() {
        const complianceInfo = `
        <h4>Terms of Use</h4>
        <ul>
            <li>You (the user) are responsible for your use of the platform. We do not collect your data, not even telemetry. Reckoning's target audience is researchers. Perform only in a protected environment and not in a publicly exposed location.</li>
            <li>Feel free to report bugs and/or request features on Github.</li>
        </ul>
        `;
        
        // Create a modal or alert with this info
        alert(complianceInfo.replace(/<[^>]*>/g, '')); // Simple alert version
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} mt-20`;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
            ${message}
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => alertDiv.remove(), 5000);
    }
    
    // Handle restore form submission
    document.getElementById('restoreForm').addEventListener('submit', function(e) {
        if (!confirm('WARNING: This will replace all current data. Are you sure you want to continue?')) {
            e.preventDefault();
            return false;
        }
        return true;
    });

    // --- Tool library + Wordlists ---
    let TOOL_LIBRARY = {{ (settings.tool_library or []) | tojson }};
    let WORDLISTS = {{ (settings.wordlists or {}) | tojson }};

    function renderToolLibrary() {
        const tbody = document.getElementById('toolLibraryTable');
        if (!tbody) return;
        tbody.innerHTML = '';
        TOOL_LIBRARY.forEach((t, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHtml(t.name || '')}</td>
                <td><code>${escapeHtml(t.path || '')}</code></td>
                <td><code>${escapeHtml(t.default_command || '')}</code></td>
                <td><code>${escapeHtml(t.update_command || '')}</code></td>
                <td>${escapeHtml(t.description || '')}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removeToolLibraryItem(${idx})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderWordlists() {
        const tbody = document.getElementById('wordlistsTable');
        if (!tbody) return;
        tbody.innerHTML = '';
        Object.keys(WORDLISTS).sort().forEach((name) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><code>${escapeHtml(name)}</code></td>
                <td><code>${escapeHtml(WORDLISTS[name] || '')}</code></td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removeWordlist('${name.replace(/'/g, "\'")}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function addToolLibraryItem() {
        const name = (document.getElementById('tl_name').value || '').trim();
        const path = (document.getElementById('tl_path').value || '').trim();
        const defCmd = (document.getElementById('tl_default_cmd').value || '').trim();
        const updCmd = (document.getElementById('tl_update_cmd').value || '').trim();
        const desc = (document.getElementById('tl_desc').value || '').trim();

        if (!name || !path) {
            alert('Tool Name and Path are required.');
            return;
        }

        const id = 'tl_' + Date.now() + '_' + Math.random().toString(16).slice(2);
        TOOL_LIBRARY.push({
            id: id,
            name: name,
            path: path,
            default_command: defCmd,
            update_command: updCmd,
            description: desc
        });

        document.getElementById('tl_name').value = '';
        document.getElementById('tl_path').value = '';
        document.getElementById('tl_default_cmd').value = '';
        document.getElementById('tl_update_cmd').value = '';
        document.getElementById('tl_desc').value = '';

        renderToolLibrary();
        saveExtraSettings();
    }

    function removeToolLibraryItem(idx) {
        TOOL_LIBRARY.splice(idx, 1);
        renderToolLibrary();
        saveExtraSettings();
    }

    function addWordlist() {
        const name = (document.getElementById('wl_name').value || '').trim();
        const path = (document.getElementById('wl_path').value || '').trim();
        if (!name || !path) {
            alert('Wordlist Name and Path are required.');
            return;
        }
        WORDLISTS[name] = path;
        document.getElementById('wl_name').value = '';
        document.getElementById('wl_path').value = '';
        renderWordlists();
        saveExtraSettings();
    }

    function removeWordlist(name) {
        delete WORDLISTS[name];
        renderWordlists();
        saveExtraSettings();
    }

    function saveExtraSettings() {
        // Merge with current settings already displayed on page by submitting only the new keys
        fetch('{{ url_for("update_settings") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tool_library: TOOL_LIBRARY,
                wordlists: WORDLISTS
            })
        }).then(r => r.json()).then((data) => {
            if (!data.success) {
                console.error(data);
                alert('Failed to save tool library/wordlists: ' + (data.error || 'unknown error'));
            }
        }).catch((e) => {
            console.error(e);
            alert('Failed to save tool library/wordlists.');
        });
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (c) => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[c]));
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderToolLibrary();
        renderWordlists();
    });
</script>
{% endblock %}